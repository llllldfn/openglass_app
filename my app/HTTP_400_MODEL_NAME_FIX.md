# HTTP 400错误修复 - 模型名称格式问题

## 问题发现

通过分析logcat日志，发现了HTTP 400错误的根本原因：

### 🔍 错误日志分析

```
"model":"ep-20250817173544-cdd9j\n "
```

**问题**：模型名称中包含了换行符 `\n` 和空格，导致JSON格式错误。

### 📊 错误流程

1. **图片数据接收成功** ✅ - "接收到图片数据: 1764 字节"
2. **AI请求构建** ✅ - 开始构建JSON请求
3. **JSON格式错误** ❌ - 模型名称包含换行符
4. **HTTP 400错误** ❌ - 服务器拒绝格式错误的请求
5. **错误处理** ✅ - 显示用户友好的错误信息

## 问题根源

### 模型名称污染
- **原始模型名称**：`ep-20250817173544-cdd9j\n `
- **问题字符**：换行符 `\n` 和尾随空格
- **JSON影响**：破坏JSON格式，导致解析失败

### 可能的原因
1. **设置界面输入错误** - 用户在输入模型名称时意外输入了换行符
2. **复制粘贴问题** - 从其他地方复制模型名称时包含了格式字符
3. **配置文件污染** - 设置文件被意外修改

## 解决方案

### 1. 模型名称清理

在所有AI请求处理函数中添加模型名称清理逻辑：

```kotlin
// 清理模型名称，移除换行符和多余空格
val cleanModel = model.trim().replace("\n", "").replace("\r", "")
```

### 2. 修复位置

#### A. AiRepository.kt
- `sendText()` - 文本处理
- `sendAudio()` - 音频处理  
- `sendImage()` - 图片处理

#### B. Settings.kt
- `read()` - 读取设置时清理
- `write()` - 写入设置时清理

### 3. 调试日志增强

添加清理过程的调试日志：

```kotlin
println("   - 清理后的模型名称: '$cleanModel'")
```

## 修复效果

### 修复前
```json
{
  "model": "ep-20250817173544-cdd9j\n ",
  "messages": [...]
}
```

### 修复后
```json
{
  "model": "ep-20250817173544-cdd9j",
  "messages": [...]
}
```

## 测试验证

### 预期日志序列
```
🖼️ 图片处理开始:
   - 原始图片大小: 1764 bytes
   - API设置: baseUrl=..., model=ep-20250817173544-cdd9j\n 
   - 清理后的模型名称: 'ep-20250817173544-cdd9j'
   - Base64编码后大小: 2352 characters
🖼️ 图片请求JSON长度: 2586 characters
✅ AI响应成功: 1 个选择
```

### 验证要点
1. **模型名称清理** - 确认换行符和空格被移除
2. **JSON格式正确** - 确认请求JSON格式正确
3. **HTTP请求成功** - 确认不再出现400错误
4. **AI响应正常** - 确认收到AI的图片分析回复

## 预防措施

### 1. 输入验证
在设置界面添加模型名称输入验证，防止用户输入无效字符。

### 2. 默认值保护
确保默认模型名称格式正确：
```kotlin
model = p.getString(KEY_MODEL, "gpt-4o") ?: "gpt-4o"
```

### 3. 日志监控
持续监控模型名称清理日志，及时发现格式问题。

## 技术细节

### 清理函数
```kotlin
fun cleanModelName(model: String): String {
    return model.trim().replace("\n", "").replace("\r", "")
}
```

### 影响范围
- ✅ 文本AI处理
- ✅ 音频AI处理
- ✅ 图片AI处理
- ✅ 设置读写

### 兼容性
- ✅ 向后兼容 - 不影响现有设置
- ✅ 自动修复 - 运行时自动清理
- ✅ 持久化 - 保存时自动清理

## 结论

通过添加模型名称清理逻辑，成功解决了HTTP 400错误。现在AI图片处理功能应该能够正常工作，不再因为JSON格式错误而失败。

**修复状态：✅ 完成**
**测试状态：🔄 待验证**
